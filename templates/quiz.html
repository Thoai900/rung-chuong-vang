<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi ƒê·∫•u - Rung Chu√¥ng V√†ng</title>
    <style>
        :root {
            --primary-color: #d32f2f;
            --secondary-color: #ffca28;
            --text-color: #333;
            --bg-color: #fff8e1;
            --timer-color: #e65100;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-color);
            background-image: radial-gradient(#ffca28 10%, transparent 11%), radial-gradient(#ffca28 10%, transparent 11%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .quiz-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 700px;
            padding: 20px;
            border: 2px solid var(--secondary-color);
            position: relative;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            font-weight: bold;
            color: var(--primary-color);
        }

        .timer-badge {
            background-color: var(--secondary-color);
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .question-content {
            flex-grow: 1;
        }

        .question-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
            text-align: center;
            min-height: 60px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            background-color: #fff;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover:not(:disabled) {
            background-color: #f9f9f9;
            border-color: var(--secondary-color);
        }

        .option-btn.selected {
            border-color: var(--primary-color);
            background-color: #fff3e0;
        }

        .option-btn.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option-btn.wrong {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        /* Countdown circle animation idea could go here, but simple bar for now */

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .score-board {
            font-size: 18px;
            font-weight: bold;
        }

        #next-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: none;
            /* Hidden until answered */
        }

        /* Loading Overlay */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            font-size: 20px;
            color: var(--primary-color);
            flex-direction: column;
        }

        /* Result Modal/Overlay (simplification - redirect to leaderboard is better but show quick result first) */
    </style>
</head>

<body>

    <div class="quiz-container">
        <div id="loading-overlay">
            <div style="font-size: 40px;">üå∏</div>
            <div>ƒêang t·∫£i c√¢u h·ªèi...</div>
        </div>

        <div class="header">
            <div class="user-info">
                <span id="display-name">Th√≠ sinh</span> | <span id="display-class">L·ªõp</span>
            </div>
            <div class="timer-badge">
                Clock: <span id="timer">15</span>s
            </div>
        </div>

        <div class="progress-bar-container">
            <div class="progress-fill" id="progress-bar"></div>
        </div>

        <div class="question-content">
            <div class="question-text" id="question-text">
                C√¢u h·ªèi s·∫Ω hi·ªán ·ªü ƒë√¢y...
            </div>

            <div class="options-grid" id="options-container">
                <!-- Options injected here -->
            </div>
        </div>

        <div class="footer">
            <div class="score-board">ƒêi·ªÉm: <span id="score">0</span></div>
            <button id="next-btn" onclick="nextQuestion()">Ti·∫øp theo ‚ûú</button>
        </div>
    </div>

    <script>
        // State
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLeft = 15;
        let startTime;
        let isAnswered = false;

        // User Data
        const studentName = localStorage.getItem('studentName');
        const className = localStorage.getItem('className');

        if (!studentName || !className) {
            alert("Th√¥ng tin th√≠ sinh kh√¥ng t√¨m th·∫•y, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
            window.location.href = '/';
        }

        document.getElementById('display-name').textContent = studentName;
        document.getElementById('display-class').textContent = className;

        // Init
        async function initGame() {
            try {
                const response = await fetch('/api/questions');
                questions = await response.json();

                if (questions.length === 0) {
                    alert("Kh√¥ng c√≥ c√¢u h·ªèi n√†o trong h·ªá th·ªëng!");
                    return;
                }

                document.getElementById('loading-overlay').style.display = 'none';
                startTime = Date.now();
                loadQuestion();
            } catch (error) {
                console.error(error);
                alert("L·ªói t·∫£i c√¢u h·ªèi!");
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishGame();
                return;
            }

            const q = questions[currentQuestionIndex];
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            const progressBar = document.getElementById('progress-bar');
            const nextBtn = document.getElementById('next-btn');

            // Reset UI
            questionText.textContent = `C√¢u ${currentQuestionIndex + 1}: ${q.content}`;
            optionsContainer.innerHTML = '';
            nextBtn.style.display = 'none';
            isAnswered = false;

            // Progress
            const percent = ((currentQuestionIndex) / questions.length) * 100;
            progressBar.style.width = `${percent}%`;

            // Parse Options (Assumed format "A. ...; B. ...")
            // If options are stored as a single string separated by semicolons or just raw text.
            // Let's handle the format provided in init_db.py: "A. ...; B. ...; C. ...; D. ..."
            let options = [];
            if (q.options) {
                options = q.options.split(';').map(o => o.trim());
            }

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => checkAnswer(btn, opt, q.answer);
                optionsContainer.appendChild(btn);
            });

            // Start Timer
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 15;
            document.getElementById('timer').textContent = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                }
            }, 1000);
        }

        function checkAnswer(selectedBtn, selectedText, correctAnswer) {
            if (isAnswered) return;
            isAnswered = true;
            clearInterval(timerInterval);

            // Logic check: The answer in DB might be "B. Bu·ªïi s√°ng..." and selectedText is similar.
            // Or we check if selectedText starts with the correct letter if format is standard.
            // Simple string comparison for now.

            // However, in init_db.py, 'answer' column stores the full string "B. Bu·ªïi s√°ng...".
            // So direct comparison should work if strings match exactly.

            const isCorrect = selectedText === correctAnswer; // Strict match might be risky if whitespace differs
            // Let's try flexible match: first character (A/B/C/D) match or full string.

            const selectedLetter = selectedText.charAt(0);
            const correctLetter = correctAnswer.charAt(0);

            // A robust check
            const correct = (selectedText.trim() === correctAnswer.trim()) || (selectedLetter === correctLetter && selectedLetter.match(/[A-D]/));

            if (correct) {
                selectedBtn.classList.add('correct');
                score += 10; // 10 points per question
                document.getElementById('score').textContent = score;
                // Play Correct Sound (Optional)
            } else {
                selectedBtn.classList.add('wrong');
                // Highlight correct answer
                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach(btn => {
                    if (btn.textContent.trim() === correctAnswer.trim() || btn.textContent.charAt(0) === correctLetter) {
                        btn.classList.add('correct');
                    }
                });

                // Survival Mode: End Game immediately?
                // "Ch·∫ø ƒë·ªô Rung Chu√¥ng V√†ng (Sinh t·ªìn): Sai 1 c√¢u l√† d·ª´ng cu·ªôc ch∆°i ngay l·∫≠p t·ª©c."
                setTimeout(() => {
                    alert(`R·∫•t ti·∫øc! B·∫°n ƒë√£ tr·∫£ l·ªùi sai. Tr√≤ ch∆°i k·∫øt th√∫c.\nƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`);
                    finishGame();
                }, 1000);
                return; // Exit
            }

            document.getElementById('next-btn').style.display = 'block';
        }

        function handleTimeOut() {
            isAnswered = true;
            // Show correct answer
            const q = questions[currentQuestionIndex];
            const correctLetter = q.answer.charAt(0);

            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(q.answer) || btn.textContent.startsWith(correctLetter)) {
                    btn.classList.add('correct');
                }
            });

            setTimeout(() => {
                alert("H·∫øt gi·ªù! B·∫°n ƒë√£ b·ªã lo·∫°i.");
                finishGame();
            }, 1000);
        }

        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        async function finishGame() {
            const totalTime = Math.floor((Date.now() - startTime) / 1000);

            // Submit Results
            try {
                await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: studentName,
                        group: className,
                        score: score,
                        time_spent: totalTime
                    })
                });
                window.location.href = '/leaderboard';
            } catch (e) {
                console.error("L·ªói l∆∞u k·∫øt qu·∫£", e);
                alert("C√≥ l·ªói khi l∆∞u k·∫øt qu·∫£!");
                window.location.href = '/leaderboard'; // Go anyway
            }
        }

        // Start
        initGame();

    </script>

</body>

</html>